<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>P2P Chat Minimal</title>
<style>
body{font-family:sans-serif; margin:20px;}
input,button{padding:5px; margin:2px;}
#peer-list{margin-top:10px;}
#chat-box{border:1px solid #ccc; padding:10px; height:200px; overflow:auto; margin-top:10px;}
.msg-me{color:blue;}
.msg-peer{color:green;}
</style>
</head>
<body>

<h2>üåê P2P Dashboard</h2>

<div>
  <h3>1Ô∏è‚É£ Submit Peer Info</h3>
  IP: <input id="ip" placeholder="127.0.0.1">
  Port: <input id="port" placeholder="9001">
  <button id="submit-peer">Submit</button>
  <div id="status"></div>
</div>

<div>
  <h3>2Ô∏è‚É£ Peer List</h3>
  <button id="refresh-peers">Refresh List</button>
  <button id="broadcast-mode">Broadcast Mode</button>
  <div id="peer-list"></div>
</div>

<div id="chat-section" style="display:none;">
  <h3>Chat with <span id="chat-with"></span></h3>
  <div id="chat-box"></div>
  <input id="msg-input" placeholder="Type a message">
  <button id="send-msg">Send</button>
</div>

<script>
let peers=[], currentPeer=null, broadcast=false;
let myIP = null;
let myPort = null;

// Helper POST form
async function postForm(path, data){
  const params = new URLSearchParams();
  for(const k in data) params.append(k,data[k]);
  const res = await fetch(path,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:params.toString()});
  return {ok:res.ok, text: await res.text()};
}

// ===== Submit Peer Info =====
document.getElementById('submit-peer').onclick = async ()=>{
  const ip=document.getElementById('ip').value.trim();
  const port=document.getElementById('port').value.trim();
  if(!ip||!port)return alert('Nh·∫≠p IP v√† Port!');
  const r = await postForm('/submit-info',{ip,port});
  document.getElementById('status').innerText=r.text;
  myIP = ip
  myPort = port
  loadPeers();
};
document.getElementById('refresh-peers').onclick = async()=>{
  loadPeers();
} 
// ===== Load Peer List =====
async function loadPeers(){
  try{
    const res = await fetch('/get-list');
    const text = await res.text();
    peers = text.split('\n').filter(Boolean).map(l=>{const [ip,port]=l.split(':'); return {ip,port};});
    renderPeerList();
  }catch(e){console.error(e);}
}

function renderPeerList(){
  const div = document.getElementById('peer-list');
  div.innerHTML='';
  peers.forEach(p=>{
    const btn = document.createElement('button');
    btn.innerText=`Connect ${p.ip}:${p.port}`;
    btn.onclick=()=>connectPeer(p.ip,p.port);
    div.appendChild(btn);
    div.appendChild(document.createElement('br'));
  });
}

// ===== Connect Peer =====
async function connectPeer(ip,port){
  if(!myIP||!myPort) return alert('Submit peer info first!');
  await postForm('/connect-peer',{source_ip:myIP,source_port:myPort,target_ip:ip,target_port:port});
  currentPeer={ip,port};
  broadcast=false;
  document.getElementById('chat-section').style.display='block';
  document.getElementById('chat-with').innerText=`${ip}:${port}`;
  loadHistory(ip,port);
}

// ===== Broadcast Mode =====
document.getElementById('broadcast-mode').onclick=()=>{
  broadcast=true;
  currentPeer=null;
  document.getElementById('chat-section').style.display='none';
  alert('Broadcast mode activated. Backend will handle sending to all peers.');
}

// ===== Load Chat History =====
async function loadHistory(ip,port){
  try{
    if(!myIP || !myPort) return alert("B·∫°n ch∆∞a ƒëƒÉng k√Ω IP/Port!");
    const res = await postForm('/get-messages',{src_ip:myIP,src_port:myPort,target_ip:ip,target_port:port}); 
    const text = await res.text;
    const lines=text.split('\n').filter(Boolean);
    const box=document.getElementById('chat-box');
    box.innerHTML='';
    lines.forEach(line=>{
      // expected format: sender|msg
      const [sender,msg]=line.split('|');
      const div=document.createElement('div');
      div.className=sender===myIP+':'+myPort?'msg-me':'msg-peer';
      div.innerText=(sender===myIP+':'+myPort?'Me':'Peer_'+sender)+': '+msg;
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  }catch(e){console.error(e);}
}

// ===== Send Message =====
document.getElementById('send-msg').onclick=async ()=>{
  const msg=document.getElementById('msg-input').value.trim();
  if(!msg||!currentPeer) return;
  await postForm('/send-peer',{source_ip:myIP,source_port:myPort,ip:currentPeer.ip,port:currentPeer.port,message:msg});
  appendMessage('me',msg);
  document.getElementById('msg-input').value='';
}

function appendMessage(from,msg){
  const box=document.getElementById('chat-box');
  const div=document.createElement('div');
  div.className=from==='me'?'msg-me':'msg-peer';
  div.innerText=(from==='me'?'Me':'Peer_'+currentPeer.ip+':'+currentPeer.port)+': '+msg;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

// ===== Initial =====
setInterval(()=>{
  if(currentPeer!=null && !broadcast ) loadHistory(currentPeer.ip,currentPeer.port);
},5000);

loadPeers();
</script>
</body>
</html>
